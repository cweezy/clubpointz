var nodemailer = require('nodemailer');
var util = require('./util');
var _ = require('underscore');

var TEXT_SUFFIX = '\n\n\n\nMessage generated by Club Pointz';
var DEFAULT_SUBJECT = 'Club Pointz Alert';
var FROM_NAME = 'Club Pointz';
var HTML_FOOTER = '<br><sub>Message generated by Club Pointz</sub>';


var AlertMailer = {

    init : function () {
       this.emailUser = util.getEnvVar('EMAIL_USER');
       this.emailPass = util.getEnvVar('EMAIL_PASS');
       this.recipients = JSON.parse(util.getEnvVar('RECIPIENTS'));
       this.from = FROM_NAME + '<' + this.emailUser + '>';
       this.pendingMessages = 0;

       return this;
    },

    _getTransport : function () {
        return nodemailer.createTransport('SMTP', {
            auth : {
                user : this.emailUser,
                pass : this.emailPass
            }
        });
    },

    _getMailOptions : function (user, subject, text, html) {
        return {
            from : this.from,
            to : user,
            subject : subject,
            text : text !== '' ? text + TEXT_SUFFIX : null,
            html : html !== '' ? html + HTML_FOOTER : null
        };
    },

    _sendMessages : function (mailOptions) {
        var transport = this._getTransport();
        _.each(mailOptions, function (options) {
            this.pendingMessages = this.pendingMessages + 1;
            var that = this;
            transport.sendMail(options, function (error, response) {
                if (error) {
                    console.log(error);
                }
                that.pendingMessages = that.pendingMessages - 1;
            });
        }, this);
    },

    send : function (options) {
        var subject = options.subject || DEFAULT_SUBJECT;
        var text = options.text || '';
        var html = options.html || '';
        var allMailOptions = [];

        _.each(this.recipients, function (user) {
            var mailOptions = this._getMailOptions(user, subject, text, html);
            allMailOptions.push(mailOptions);
        }, this);
        this._sendMessages(allMailOptions);
    },

    getPendingMessages : function () {
        return this.pendingMessages;
    }
};

exports.mailer = AlertMailer.init();
